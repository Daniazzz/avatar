
<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- ios support -->
    <link href="icon/manifest/192x192.png" rel="apple-touch-icon" />
    <meta content="#DCE9E9" name="apple-mobile-web-app-status-bar" />
    <meta content="#d1d1d1" name="theme-color" />
    <title>Orient DOTS</title>
    <link href="https://orientdots.net/avatar/assests/icon.png" rel="shortcut icon" type="image/png" />
    <link href="manifest.json" rel="manifest" />
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').then(() => {
                    console.log('Service Worker Registered!');
                });
            });
        }
    </script>
    <!-- Google fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Baloo+Tammudu+2&amp;family=Roboto:wght@100&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@600&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <!-- Include Flag Icon CSS in <head> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/6.7.0/css/flag-icons.min.css" />
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
        }
	
        .video-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
            opacity: 0.9;
            /* Set opacity to 0.5 */
        }

        #video-bg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            z-index: 1;
        }

        .iframe-overlay {
            position: fixed;
            top: 0;
            right: 0;
            /* Position on the right side */
            width: 330px;
            /* Set the width to 300px */
            height: 330px;
            /* Set the height to 300px */
            background: transparent;
            /* Set the background to transparent */
            display: block;
            /* Initially hidden */
            z-index: 3000;
            /* Set the z-index to 3000 for the overlay */
            border: none;
        }

        #open-overlay-button {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 3000;
            /* Set the z-index to 3000 for the button */
            background: #fff;
            padding: 10px;
            border: none;
            cursor: pointer;
        }

        #close-overlay-button {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1001;
            /* Above the overlay */
            background: #fff;
            padding: 10px;
            border: none;
            cursor: pointer;
        }

        /* unvisited link */
        a:link {
            color: white;
        }

        /* visited link */
        a:visited {
            color: white;
        }

        /* mouse over link */
        a:hover {
            color: white;
        }

        /* selected link */
        a:active {
            color: white;
        }

        .container-fluid {
            /* background-color: #fff; */
            max-width: 100%;
        }

        .chat-box {
            z-index: 4;
            opacity: 0.8;
            /* border: 1px solid #dee2e6; */
            border-radius: 0.25rem;
            max-height: 91vh;
            min-height: 91vh;
            overflow-y: auto;
            margin-top: 10px;
            font-size: 12px;
            width: 25%;
        }

        #chat-box {
            display: flex;
            flex-direction: column-reverse;
            overflow-y: auto;
            max-height: 91vh;
        }

        #chat-form {
            z-index: 3;
            position: sticky;
            width: 100%;
            bottom: 0;
            left: 0;
            right: 0;
            /* background-color: #e3ecf1; */
            border-radius: 15px;
            padding: 8px;
        }

        @media (max-width: 767px) {

            /* Adjust the breakpoint as needed */
            .chat-box {
                width: 91%;
                max-height: 20vh;
                /* Adjust the height as needed */
                min-height: 20vh;
                position: fixed;
                bottom: 40px;
                /* Height of the chat form + some padding */
                margin-top: 0;
                /* Remove the top margin */
                left: 50%;
                transform: translateX(-50%);
            }
        }

        #chat-box {
            max-height: 20vh;
            /* Adjust the height as needed */
        }

        #chat-form {
            position: fixed;
            bottom: 0;
            width: 100%;
            left: 0;
            right: 0;
        }
        }

        .chat-message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .message-text {
            word-wrap: break-word;
        }

        #user-input {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .user-message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: red;
            color: #fff;
            align-self: flex-end;
        }

        .chatbot-message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #f0f0f0;
            color: #000000;
        }

        .message-text {
            word-wrap: break-word;
        }

        .imgAvatar {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            /* Ensures the video maintains its aspect ratio while covering the viewport */
            transform: translate(-50%, -50%);
            z-index: 2;
        }

        /* Apply this CSS for mobile screens */
        @media (max-width: 768px) {
            .avatar-container {
                overflow: hidden;
                /* Hide the overflowing parts */
            }

            .avatar-image {
                width: auto;
                /* Let the width adjust proportionally */
                height: 100%;
                /* Ensure the image fills the container vertically */
                margin-left: 50%;
                /* Center the image horizontally */
                transform: translateX(-50%);
                /* Adjust for centering */
            }
        }

        .full-height {
            height: 100vh;
        }

        .iframeApps {
            display: block;
            /* iframes are inline by default */
            margin: 0;
            background: #000;
            border: none;
            /* Reset default border */
            height: 100vh;
            /* Viewport-relative units */
            width: 75vw;
        }

        .iframeAva {
            display: block;
            /* iframes are inline by default */
            background: #ffffff;
            border: none;
            /* Reset default border */
            height: 100vh;
            /* Viewport-relative units */
            width: 100%;
        }

        .video-container {
            width: auto;
            height: 100%;
            display: block;
        }

        .dropdown-menu::before {
            content: '';
            display: inline-block;
            border-left: 7px solid transparent;
            border-right: 7px solid transparent;
            border-bottom: 7px solid #ccc;
            border-bottom-color: #fff;
            border-bottom-color: #fff;
            position: absolute;
            top: -7px;
            left: 9px;
        }

        .sticky-div {
            position: fixed;
            top: 65px;
            right: 0;
            height: 100%;
            width: 25%;
            /* Adjust the width to your desired value */
            z-index: 1000;
        }

        .sticky-navbar {
            position: sticky;
            /* or you can use 'sticky' if you prefer */
            top: 0;
            width: 100%;
            z-index: 1000;
            /* Keeps the navbar on top of other elements */
        }

        #logo {
            position: fixed;
            margin-top: 10px;
            bottom: 100px;
            right: 30px;
            opacity: 0.80;
            z-index: 3;
        }

        /* Media query for mobile devices */
        @media (max-width: 768px) {
            #logo {
                top: 10px;
                /* Adjust as needed */
                bottom: auto;
                /* Reset the bottom property */
                right: 10px;
                /* Adjust as needed */
                left: auto;
                /* Optional, if you want to center horizontally */
                margin: 0;
                /* Reset margin */
            }
        }

        @media (max-width: 767px) and (orientation: landscape),
        /* Mobile landscape */
        (max-width: 768px) {

            .imgAvatar {
                height: auto;
                width: 100%;
            }

            /* Include the original condition */
            .iframe-overlay {
                display: none;
            }
        }

        .avatar-video {
            /* position: fixed; */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: auto;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 3;
        }

        #export-controls {
            display: none !important;
        }
/* ‚úÖ Mobile adjustments */
@media (max-width: 768px) {
    /* Chat box above menu */
    .chat-box {
        position: fixed !important;
        bottom: 70px !important;             /* sits above menu */
        left: 50% !important;
        transform: translateX(-50%) !important;
        width: 95% !important;
        max-height: 40vh !important;
        min-height: 20vh !important;
        border-radius: 10px !important;
        background: rgba(255,255,255,0.95) !important;
        z-index: 10001 !important;           /* above everything */
        pointer-events: auto !important;
    }

    /* Menu bar pinned at bottom, scrollable */
    #chat-form {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        width: 100% !important;
        display: flex !important;
        flex-wrap: nowrap !important;        /* keep buttons in one row */
        overflow-x: auto !important;         /* enable horizontal scroll */
        gap: 6px !important;
        background: #fff !important; 
        padding: 6px 8px !important;
        box-shadow: 0 -2px 6px rgba(0,0,0,0.15) !important;
        z-index: 10000 !important;           /* under chat box */
        border-radius: 0 !important;
        -webkit-overflow-scrolling: touch !important; /* smooth scroll iOS */
    }

    /* Input expands full width */
    #chat-form input[type="text"] {
        flex: 1 !important;
        margin-right: 8px !important;
    }

    /* Buttons uniform size */
    #chat-form .menu-btn,
    #chat-form button {
        flex: 0 0 auto !important;
        padding: 8px 10px !important;
        font-size: 16px !important;
    }

    /* Hide scrollbar (optional) */
    #chat-form::-webkit-scrollbar {
        display: none;
    }

    /* Keep avatar & background behind */
    .imgAvatar,
    .video-background {
        z-index: 1 !important;
    }
}
@media (max-width: 768px) {
    #chat-form {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        width: 100% !important;
        display: flex !important;
        flex-direction: column !important; /* stack input above menu */
        background: #fff !important;
        padding: 6px 8px !important;
        box-shadow: 0 -2px 6px rgba(0,0,0,0.15) !important;
        z-index: 9999 !important;
        border-radius: 0 !important;
    }

    /* Chat input row */
    #chat-form .form-control {
        margin-bottom: 6px !important;  /* spacing between input and menu */
        width: 100% !important;
    }

    /* Menu buttons row */
    #chat-form .menu-row {
        display: flex !important;
        flex-wrap: nowrap !important;	
        overflow-x: auto !important;
        gap: 6px !important;
        -webkit-overflow-scrolling: touch !important;
    }

    #chat-form .menu-row button {
        flex: 0 0 auto !important;
        padding: 8px 10px !important;
        font-size: 16px !important;
    }

    #chat-form .menu-row::-webkit-scrollbar {
        display: none;
    }
}

    </style>
    <link
        href="https://fonts.googleapis.com/css?family=Roboto:300,400,500|Material+Icons|Material+Icons+Outlined|Material+Icons+Two+Tone|Material+Icons+Round|Material+Icons+Sharp"
        rel="stylesheet" />
    <!-- Jquery -->
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://studio.orient-telecoms.com/publishing/avatar/js/fullscreenV2.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
	<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix"></script> -->
    <!-- Local link -->
    <link href="manifest.json" rel="manifest" />
    <script src="app.js"></script>
    <link href="./plugins/orientAI/static/icon/Css/style.css" rel="stylesheet" />
    </link>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/franc@6.1.0/build/franc.min.js"></script>
</head>
<script>
    const overlayIframe = document.getElementById('overlay-iframe');
    const closeOverlayButton = document.getElementById('close-overlay-button');

    // Function to show the overlay with the external URL
    function showOverlay() {
        overlayIframe.style.display = 'block';
    }

    // Function to hide the overlay
    function hideOverlay() {
        overlayIframe.style.display = 'none';
    }

    // Add an event listener to the button to show the overlay
    document.getElementById('open-overlay-button').addEventListener('click', showOverlay);

    // Add an event listener to the close button to hide the overlay
    closeOverlayButton.addEventListener('click', hideOverlay);
</script>
<script>
    let vid = document.getElementById("imgAvatar");

    // Set default playback speed
    vid.playbackRate = 50;

</script>

<body>
    <div class="modal" id="nameModal" role="dialog"
        style="display:block; background: rgba(0,0,0,0.8); z-index:9999; position:fixed; top:0; left:0; right:0; bottom:0;"
        tabindex="-1">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content p-4">
                <h5 class="modal-title" id="modalGreeting">Welcome! What's your name?</h5>
                <input class="form-control my-3" id="userNameInput" placeholder="Enter your name" required=""
                    type="text" />
                <button class="btn btn-primary" id="submitNameBtn">Continue</button>
            </div>
        </div>
    </div>

    <!-- ‚úÖ ADD THIS in <body>, near the top (before container-fluid) -->
    <select id="language-selector" class="form-select"
        style="position:fixed;top:50px;left:10px;width:200px;z-index:9999;">
        <option value="auto">üåê Auto Detect</option>
        <option value="en-US">üá∫üá∏ English (US)</option>
        <option value="ms-MY">üá≤üáæ Malay</option>
        <option value="zh-CN">üá®üá≥ Chinese (Simplified)</option>
        <option value="hi-IN">üáÆüá≥ Hindi</option>
        <option value="th-TH">üáπüá≠ Thai</option>
        <option value="ja-JP">üáØüáµ Japanese</option>
        <option value="ko-KR">üá∞üá∑ Korean</option>
        <option value="fr-FR">üá´üá∑ French</option>
        <option value="de-DE">üá©üá™ German</option>
        <option value="ru-RU">üá∑üá∫ Russian</option>
        <option value="es-ES">üá™üá∏ Spanish</option>
        <option value="it-IT">üáÆüáπ Italian</option>
        <option value="tr-TR">üáπüá∑ Turkish</option>
        <option value="ar-SA">üá∏üá¶ Arabic</option>
        <option value="fa-IR">üáÆüá∑ Persian</option>
    </select>

    <div id="tts-indicator" style="
    position: fixed;
    top: 20px;
    left: 20px;
    width: 20px;
    height: 20px;
    background-color: red;
    border-radius: 50%;
    box-shadow: 0 0 10px red;
    z-index: 9999;
    display: none;">
    </div>

    <div class="video-background">
        <video autoplay="" id="video-bg" loop="" muted="">


            <source src="https://studio.orient-telecoms.com/publishing/avatar/background/ORT-AVABG18.mp4"
                type="video/mp4">


            <!-- Add more <source> tags for other video formats if needed -->
            Your browser does not support the video tag.
        </video>

        <!-- <script>
			document.getElementById('video-bg').playbackRate = 0.2; // Adjust the playback rate (0.5 means half speed)
		</script> -->

    </div>

    <div id="logo">
        <img src="https://studio.orient-telecoms.com/img/avatarstudios-final.png">
    </div>

    <!-- <iframe id="overlay-iframe" class="iframe-overlay" src="https://desktop.orient-dots.com/GPU/index.php"></iframe> -->

    <!-- <button id="open-overlay-button">Open Overlay</button>   -->

    <div class="content h-100">

        <div class="container-fluid d-flex flex-column h-100">
            <div class="row flex-grow-1">
                <div class="col-md-12 d-flex flex-column">
                    <div id="avatar-container" style="position: relative;">

                        <!-- Poster Video -->
                        <video autoplay="" class="imgAvatar avatar-video" loop="" muted="" playsinline=""
                            style="opacity:1; z-index:1;">
                            <source
                                src="https://studio.orient-telecoms.com/publishing/avatar/Male/ORT-AVA25/ORT-AVA25-Idle.webm"
                                type="video/webm" />
                            Your browser does not support HTML5 video.
                        </video>
                        <!-- Idle Video -->
                        <video autoplay="" class="imgAvatar avatar-video" id="idleVideo" loop="" muted="" playsinline=""
                            style="opacity:1; z-index:2;">
                            <source
                                src="https://studio.orient-telecoms.com/publishing/avatar/Male/ORT-AVA25/ORT-AVA25-Idle.webm"
                                type="video/webm" />
                            Your browser does not support HTML5 video.
                        </video>
                        <!-- Talk Video -->
                        <video autoplay="" class="imgAvatar avatar-video" id="talkVideo" loop="" muted="" playsinline=""
                            style="opacity:0; z-index:3;">
                            <source
                                src="https://studio.orient-telecoms.com/publishing/avatar/Male/ORT-AVA25/ORT-AVA25-Talk.webm"
                                type="video/webm" />
                            Your browser does not support HTML5 video.
                        </video>

                    </div>

                    <script>
                        const idleVideo = document.getElementById("idleVideo");
                        const talkVideo = document.getElementById("talkVideo");

                        // Ensure both videos load and play
                        Promise.all([
                            idleVideo.play(),
                            talkVideo.play()
                        ]).then(() => {
                            idleVideo.currentTime = 0;
                            talkVideo.currentTime = 0;
                        });

                        function syncAndFade(fromVideo, toVideo) {
                            toVideo.currentTime = fromVideo.currentTime;

                            // Smooth fade transition
                            fromVideo.style.transition = "opacity 0.3s ease-in-out";
                            toVideo.style.transition = "opacity 0.3s ease-in-out";

                            fromVideo.style.opacity = "0";
                            toVideo.style.opacity = "1";
                        }

                        // Call this when speaking starts
                        function showTalkVideo() {
                            syncAndFade(idleVideo, talkVideo);
                        }

                        // Call this when speaking ends
                        function showIdleVideo() {
                            syncAndFade(talkVideo, idleVideo);
                        }
                    </script>
                    <script>
                        var video = document.getElementById('imgAvatar');

                        // Wait for the metadata to be loaded
                        video.addEventListener('loadedmetadata', function () {
                            // Set the starting time to 1 second
                            video.currentTime = 1;

                            // Play the video until 8 seconds
                            video.addEventListener('timeupdate', function () {
                                if (video.currentTime >= 6) {
                                    video.currentTime = 1; // Restart the video from 1 second
                                }
                            });
                        });
                    </script>
                    <script>
                        function toggleElements() {
                            var chatBox = document.getElementById("chat-box");

                            // Toggle visibility
                            if (chatBox.style.display === "none") {
                                chatBox.style.display = "flex";
                            } else {
                                chatBox.style.display = "none";
                            }
                        }
                    </script>
                    <script>
                        function toggleFullScreen() {
                            if (!document.fullscreenElement) {
                                document.documentElement.requestFullscreen();
                            } else {
                                if (document.exitFullscreen) {
                                    document.exitFullscreen();
                                }
                            }
                        }
                    </script>
                    <script>
                        document.addEventListener('contextmenu', function (e) {
                            e.preventDefault();
                        });
                    </script>
                    <!-- <div id="chat-box" class="chat-box flex-grow-1 mb-3 p-3 bg-light rounded"> -->
                    <div class="chat-box flex-grow-1 mb-3 p-3 rounded" id="chat-box" style="display:none">
                        <!-- Chat messages will be appended here -->
                    </div>
                    <form class="input-group fixed-bottom px-3 py-2" id="chat-form">
                        <input autocomplete="off" class="form-control rounded-pill" id="user-input"
                            placeholder="Type your message..." required="" type="text" />
                        <button class="btn btn-primary d-none" type="submit">Send</button>
                        <span class="input-group-text">
                            <button class="btn btn-danger ms-2" id="microphone-btn" type="button">
                                <i class="fas fa-head-side-cough"></i>
                            </button>
                            &nbsp;&nbsp;
                            <button class="btn btn-danger ms-2" id="stop-tts-btn" type="button">
                                <i class="fas fa-head-side-cough-slash"></i>
                            </button>
                            &nbsp;&nbsp;
                            <button class="btn btn-warning ms-2" onclick="removeContent()" type="button">
                                <i class="fas fa-user-minus"></i>
                            </button>
                            &nbsp;&nbsp;
                            <button class="btn btn-info ms-2" onclick="toggleElements()" type="button">
                                <i class="fas fa-eye-slash"></i>
                            </button>
                            &nbsp;&nbsp;
                            <button class="btn btn-primary ms-2" onclick="toggleFullScreen()" type="button">
                                <i class="fas fa-expand"></i>
                            </button>
                            <!-- &nbsp;&nbsp;
							<input type="range" id="voice-speed" min="0.5" max="2" step="0.1" value="2" disabled /> -->
                            &nbsp;&nbsp;
                            <button class="btn btn-secondary ms-2" id="pause-tts-btn" type="button">
                                <i class="fas fa-pause-circle"></i>
                            </button>
                            &nbsp;&nbsp;
                            <button class="btn btn-success ms-2" id="resume-tts-btn" type="button">
                                <i class="fas fa-play-circle"></i>
                            </button>
                            &nbsp;&nbsp;
                            <button class="btn btn-dark ms-2" id="save-chat-btn" type="button">
                                <i class="fas fa-save"></i>
                            </button>
                            &nbsp;&nbsp;
                            <button class="btn btn-outline-secondary ms-2" id="upload-chat-btn" type="button">
                                <i class="fas fa-upload"></i>
                                <input type="file" id="upload-chat-input" accept=".json,.csv" style="display:none" />
                            </button>
                        </span>
                    </form>
                    <div id="export-controls" style="margin-top: 1rem;">
                        <label>From: <input id="start-date" type="datetime-local" /></label>
                        <label>To: <input id="end-date" type="datetime-local" /></label>
                        <button class="btn btn-warning ms-2" id="export-pdf-btn">üìÑ Export to PDF</button>
                        <input accept=".json,.csv" class="ms-2" id="import-log" type="file" />
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let output = document.getElementById('output');
        function removeContent() {
            let divElement = document.getElementById("chat-box");
            while (divElement.firstChild) {
                divElement.removeChild(divElement.firstChild);
            }
        }
    </script>
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>


    
    <script>
    const GEMINI_API_KEY = "AIzaSyBE4Tw_30cYCMFdZ6GirOP1Z10DE5Qafbs";
    const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent";

    const chatBox = document.getElementById("chat-box");
    const chatForm = document.getElementById("chat-form");
    const microphoneBtn = document.getElementById("microphone-btn");

    let conversationHistory = [{ role: "assistant", content: "You are Prime the Digital AI Assistant. You are Professional." }];

    // ‚úÖ Handles form submission
    chatForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const userInputElement = document.getElementById("user-input");
        const userInput = userInputElement.value;
        appendMessage(userInput, "user");
        chatForm.reset();

        // Disable typing while waiting
        userInputElement.disabled = true;

        try {
            const response = await fetchGPTResponse(userInput);
            appendMessage(response, "chatbot");
        } catch (error) {
            console.error("Error fetching response:", error);
            appendMessage("‚ùå Sorry, there was an error. Please try again.", "chatbot");
        } finally {
            // ‚úÖ Always re-enable input
            userInputElement.disabled = false;
            userInputElement.focus();
        }
    });

    // ‚úÖ Fetch response from Gemini 2.5 API
    async function fetchGPTResponse(prompt) {
        const headers = { "Content-Type": "application/json" };
        const requestBody = {
            model: "gemini-2.5-flash",
            contents: [{
                role: "user",
                parts: [{ text: prompt }]
            }],
            generationConfig: {
                temperature: 0.7,
                maxOutputTokens: 500,
                topP: 0.8,
                topK: 40
            },
            safetySettings: [
                { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
            ]
        };

        try {
            const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                method: "POST",
                headers,
                body: JSON.stringify(requestBody),
            });

            if (!response.ok) {
                const errorResponse = await response.json();
                console.error("Gemini API Error:", errorResponse);
                throw new Error("Gemini API Error");
            }

            const jsonResponse = await response.json();
            console.log("Gemini response:", jsonResponse); // ‚úÖ Debug log
            const textResponse = jsonResponse.candidates?.[0]?.content?.parts?.[0]?.text || "‚ö†Ô∏è No response.";
            return textResponse;
        } catch (error) {
            console.error("Error fetching Gemini response:", error);
            return "‚ùå ERROR! Please check Gemini API settings.";
        }
    }
    </script>

    <script>
        const idleVideo = document.getElementById("idleVideo");
        const talkVideo = document.getElementById("talkVideo");

        // Ensure both videos preload and stay in sync
        idleVideo.loop = true;
        idleVideo.muted = true;
        talkVideo.loop = false;
        talkVideo.muted = true;

        Promise.all([
            idleVideo.play().catch(() => { }),
            talkVideo.play().catch(() => { })
        ]).then(() => {
            idleVideo.currentTime = 0;
            talkVideo.currentTime = 0;
        });

        // Smooth transition between idle and talk
        function syncAndFade(fromVideo, toVideo) {
            toVideo.currentTime = 0;
            fromVideo.style.transition = "opacity 0.3s ease-in-out";
            toVideo.style.transition = "opacity 0.3s ease-in-out";
            fromVideo.style.opacity = "0";
            toVideo.style.opacity = "1";
        }

        function showTalkVideo() {
            syncAndFade(idleVideo, talkVideo);
            talkVideo.play().catch(() => { });
        }

        function showIdleVideo() {
            syncAndFade(talkVideo, idleVideo);
            idleVideo.play().catch(() => { });
        }

        // üîÅ Optional Auto-Loop Demo: idle <-> talk every 4 seconds
        let autoLoop = true; // Set to false if you only want real voice control
        if (autoLoop) {
            let isTalking = false;
            setInterval(() => {
                if (isTalking) {
                    showIdleVideo();
                } else {
                    showTalkVideo();
                }
                isTalking = !isTalking;
            }, 4000); // Toggle every 4 seconds
        }

        // Optional: toggle manually from console or trigger
        window.showTalkVideo = showTalkVideo;
        window.showIdleVideo = showIdleVideo;
    </script>
    <script>
        document.getElementById("pause-tts-btn").addEventListener("click", pauseTTS);
        document.getElementById("resume-tts-btn").addEventListener("click", resumeTTS);
    </script>
    <script>
        document.getElementById("save-chat-btn").addEventListener("click", function () {
            const start = new Date(document.getElementById("start-date").value);
            const end = new Date(document.getElementById("end-date").value);
            const chatBox = document.getElementById("chat-box");
            const messages = [];
            chatBox.querySelectorAll(".user-message, .chatbot-message").forEach(msg => {
                const type = msg.classList.contains("user-message") ? "user" : "bot";
                const text = msg.querySelector("span.message-text")?.innerText || "";
                const time = msg.querySelector("div")?.innerText || "";
                const timestamp = new Date(time);
                if ((!isNaN(start) && timestamp < start) || (!isNaN(end) && timestamp > end)) return;
                messages.push({ type, text, time });
            });

            const format = prompt("Save as: json or csv?", "json").toLowerCase();
            const now = new Date();
            const filenameTime = now.toISOString().replace(/[:.]/g, "-");
            let blob;
            let filename;

            if (format === "csv") {
                const csv = "type,time,text\n" + messages.map(m =>
                    `"${m.type}","${m.time}","${m.text.replace(/"/g, '""')}"`).join("\n");
                blob = new Blob([csv], { type: "text/csv" });
                filename = `chatlog-${filenameTime}.csv`;
            } else {
                const json = JSON.stringify(messages, null, 2);
                blob = new Blob([json], { type: "application/json" });
                filename = `chatlog-${filenameTime}.json`;
            }

            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
        });

        // Export to PDF using jsPDF
        document.getElementById("export-pdf-btn").addEventListener("click", async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 10;
            const chatBox = document.getElementById("chat-box");
            doc.setFontSize(10);
            chatBox.querySelectorAll(".user-message, .chatbot-message").forEach(msg => {
                const type = msg.classList.contains("user-message") ? "User" : "Bot";
                const text = msg.querySelector("span.message-text")?.innerText || "";
                const time = msg.querySelector("div")?.innerText || "";
                const line = `[${time}] ${type}: ${text}`;
                const lines = doc.splitTextToSize(line, 180);
                lines.forEach(l => {
                    doc.text(l, 10, y);
                    y += 6;
                    if (y > 280) {
                        doc.addPage();
                        y = 10;
                    }
                });
            });
            doc.save("chatlog.pdf");
        });

        // Upload and parse log file
        document.getElementById("import-log").addEventListener("change", function () {
            const file = this.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    let content = e.target.result;
                    const messages = file.name.endsWith(".csv") ? parseCSV(content) : JSON.parse(content);
                    messages.forEach(msg => {
                        const msgDiv = document.createElement("div");
                        msgDiv.className = msg.type === "user" ? "user-message" : "chatbot-message";
                        const span = document.createElement("span");
                        span.className = "message-text";
                        span.textContent = msg.text;
                        const timeDiv = document.createElement("div");
                        timeDiv.style.fontSize = '10px';
                        timeDiv.style.color = '#888';
                        timeDiv.textContent = msg.time;
                        msgDiv.appendChild(span);
                        msgDiv.appendChild(timeDiv);
                        document.getElementById("chat-box").appendChild(msgDiv);
                    });
                } catch (err) {
                    alert("Error parsing file.");
                }
            };
            reader.readAsText(file);
        });

        function parseCSV(content) {
            const lines = content.trim().split("\n");
            const headers = lines.shift().split(",");
            return lines.map(line => {
                const parts = line.split(",");
                return {
                    type: parts[0].replace(/"/g, ''),
                    time: parts[1].replace(/"/g, ''),
                    text: parts.slice(2).join(",").replace(/"/g, '')
                };
            });
        }
    </script>

    <script>
        document.getElementById("upload-chat-btn").addEventListener("click", () => {
            document.getElementById("upload-chat-input").click();
        });

        document.getElementById("upload-chat-input").addEventListener("change", function () {
            const file = this.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    let content = e.target.result;
                    const messages = file.name.endsWith(".csv") ? parseCSV(content) : JSON.parse(content);
                    messages.forEach(msg => {
                        const msgDiv = document.createElement("div");
                        msgDiv.className = msg.type === "user" ? "user-message" : "chatbot-message";
                        const span = document.createElement("span");
                        span.className = "message-text";
                        span.textContent = msg.text;
                        const timeDiv = document.createElement("div");
                        timeDiv.style.fontSize = '10px';
                        timeDiv.style.color = '#888';
                        timeDiv.textContent = msg.time;
                        msgDiv.appendChild(span);
                        msgDiv.appendChild(timeDiv);
                        document.getElementById("chat-box").appendChild(msgDiv);
                    });
                } catch (err) {
                    alert("Error parsing chat log.");
                }
            };
            reader.readAsText(file);
        });
    </script>


</body>

</html>
